<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SmartLipad - Predictions</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;margin:0;padding:0}
:root{--page-bg:#f5f7fb;--card:#ffffff;--muted:#6b7280;--text:#0b1220;--link-blue:#2563eb;--green:#10b981;--red:#ef4444;--light-border:rgba(15,23,42,0.06);--shadow:0 6px 18px rgba(11,36,64,0.04)}
html,body{height:100%;background:var(--page-bg);color:var(--text)}
.wrapper{max-width:1200px;margin:28px auto;padding:24px}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:8px 4px;border-bottom:1px solid rgba(11,36,64,0.04)}
.topbar-left{display:flex;align-items:center;gap:12px}
.back-btn{display:inline-flex;align-items:center;gap:10px;color:var(--muted);cursor:pointer;font-size:14px}
.back-btn img{width:18px;height:18px}
.brand{display:inline-flex;align-items:center;gap:8px;font-weight:700;color:var(--text)}
.brand img{width:20px;height:20px}
.topnav{display:flex;gap:18px;align-items:center}
.topnav a{color:var(--muted);text-decoration:none;padding:8px 14px;border-radius:8px;font-size:14px}
.topnav a.active{background:#0b1220;color:#fff;padding:8px 16px;border-radius:10px;box-shadow:0 6px 18px rgba(11,36,64,0.12)}
.header{display:flex;flex-direction:column;align-items:center;gap:8px;margin-top:18px}
.header .icon-wrap{width:48px;height:48px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbf2ff);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 10px rgba(124,77,255,0.08)}
.header .icon-wrap img{width:26px;height:26px}
.title-main{font-size:22px;font-weight:700}
.title-sub{color:var(--muted);font-size:13px;max-width:760px;text-align:center}
.route-card{background:var(--card);border-radius:12px;padding:18px;margin:22px 0;box-shadow:var(--shadow);border:1px solid var(--light-border);display:flex;align-items:center;justify-content:space-between}
.route-left{display:flex;align-items:center;gap:12px}
.route-left img{width:18px;height:18px}
.route-left .route-meta{display:flex;flex-direction:column}
.route-left .route-title{font-size:13px;color:var(--muted)}
.route-left .route-value{font-weight:700;color:var(--link-blue)}
.route-right{display:flex;align-items:center;gap:12px;color:var(--muted);font-size:13px}
.summary-row{display:flex;gap:20px;align-items:stretch;justify-content:space-between;margin:6px 0 26px 0}
.summary-card{flex:1;min-width:0;background:var(--card);border-radius:10px;padding:22px 20px;display:flex;gap:16px;align-items:flex-start;border:1px solid var(--light-border);box-shadow:0 6px 14px rgba(11,36,64,0.03)}
.summary-left{width:46px;display:flex;align-items:flex-start;justify-content:center;padding-top:4px}
.summary-left img{width:22px;height:22px;display:block}
.summary-body{flex:1;display:flex;flex-direction:column;align-items:flex-start}
.small-label{color:var(--muted);font-size:13px}
.big-label{font-size:22px;font-weight:800;margin-top:6px;line-height:1}
.price{font-size:15px;margin-top:8px;color:#111827}
.pill{display:inline-flex;align-items:center;gap:8px;margin-top:12px;padding:6px 12px;border-radius:16px;font-weight:700;font-size:12px}
.pill.green{background:rgba(16,185,129,0.08);color:var(--green)}
.pill.red{background:rgba(239,68,68,0.06);color:var(--red)}
.pill.blue{background:rgba(37,99,235,0.06);color:var(--link-blue)}
.chart-card{background:var(--card);border-radius:10px;padding:18px;border:1px solid var(--light-border);box-shadow:var(--shadow);margin-bottom:20px}
.chart-title{font-weight:700;margin-bottom:12px}
.canvas-fixed{width:100%;height:320px;max-height:420px;position:relative}
.canvas-fixed canvas{width:100% !important;height:100% !important;display:block}
.empty{display:flex;align-items:center;justify-content:center;height:320px;color:#6b7280;border:1px dashed var(--light-border);border-radius:10px;background:#fff}
.how-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:12px}
.how-box{background:var(--card);padding:18px;border-radius:10px;border:1px solid var(--light-border);box-shadow:0 6px 14px rgba(11,36,64,0.03)}
.how-box h3{display:flex;align-items:center;gap:10px;font-size:15px;margin-bottom:8px}
.how-box h3 img{width:18px;height:18px}
.how-footer{margin-top:12px;padding:12px;background:rgba(124,77,255,0.06);border-radius:8px;font-size:13px;color:var(--muted);border:1px solid rgba(124,77,255,0.08)}
@media (max-width:1000px){.wrapper{padding:16px}.summary-row{flex-direction:column}.how-grid{grid-template-columns:1fr}.canvas-fixed{height:260px}}
.skeleton{position:relative;overflow:hidden;background:#eef0f5;border-radius:8px}
.skeleton.inline{display:inline-block;height:1em;line-height:1em}
.skeleton::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,rgba(255,255,255,0) 0%,rgba(255,255,255,.8) 50%,rgba(255,255,255,0) 100%);transform:translateX(-100%);animation:shimmer 1.4s infinite}
@keyframes shimmer{100%{transform:translateX(100%)}}
.chart-skeleton{height:320px;border:1px dashed var(--light-border);background:#fff}
.hidden{display:none}
</style>
</head>
<body>
<div class="wrapper">
  <div class="topbar">
    <div class="topbar-left">
      <div class="back-btn" onclick="history.back()"><img src="assets/left_arrow.png" alt="back">Back</div>
      <div class="brand"><img src="assets/airplane.png" alt="brand">SmartLipad</div>
    </div>
    <div class="topnav">
      <a href="index.html">Home</a>
      <a href="search.html">Search</a>
      <a class="active" href="predictions.html">Predictions</a>
      <a href="compare.html">Compare</a>
    </div>
  </div>

  <div class="header">
    <div class="icon-wrap"><img src="assets/brain_symbol.png" alt="ai"></div>
    <div class="title-main">AI Fare Predictions</div>
    <div class="title-sub">Our AI analyzes historical flight data and live prices to help you time your booking.</div>
  </div>

  <div class="route-card">
    <div class="route-left">
      <img src="assets/airplane.png" alt="plane">
      <div class="route-meta">
        <div class="route-title">Current Route</div>
        <div class="route-value" id="currentRoute">—</div>
        <div class="route-title" id="currentDates" style="margin-top:4px;color:#6b7280">—</div>
      </div>
    </div>
    <div class="route-right"><img src="assets/brain_symbol.png" alt="ai small" style="width:20px;height:20px">AI Powered</div>
  </div>

  <div class="summary-row">
    <div class="summary-card">
      <div class="summary-left"><img src="assets/green_trend.png" alt="best"></div>
      <div class="summary-body">
        <div class="small-label" id="bestLabel">Best Time to Fly</div>
        <div class="big-label" id="bestMonth">—</div>
        <div class="price" id="bestPrice">—</div>
        <div class="pill green" id="bestPill"><span id="savings">—</span></div>
      </div>
    </div>
    <div class="summary-card">
      <div class="summary-left"><img src="assets/red_trend.png" alt="expensive"></div>
      <div class="summary-body">
        <div class="small-label" id="expLabel">Most Expensive</div>
        <div class="big-label" id="expMonth">—</div>
        <div class="price" id="expPrice">—</div>
        <div class="pill red" id="peakPill">Peak Season</div>
      </div>
    </div>
    <div class="summary-card">
      <div class="summary-left"><img src="assets/I_Button.png" alt="avg"></div>
      <div class="summary-body">
        <div class="small-label">Average Fare</div>
        <div class="big-label" id="avgFare">—</div>
        <div class="small-label" id="avgNote">12-Month Average</div>
        <div class="pill blue" id="yearPill">Yearly Trend</div>
      </div>
    </div>
  </div>

  <div class="chart-card">
    <div class="chart-title">12-Month Fare Forecast</div>
    <div class="canvas-fixed">
      <div id="lineSkel" class="chart-skeleton skeleton"></div>
      <canvas id="lineChart" class="hidden"></canvas>
    </div>
    <div class="empty" id="yearEmpty" style="display:none">No forecast available for this route.</div>
  </div>

  <div class="chart-card">
    <div class="chart-title">Monthly Fare Breakdown</div>
    <div class="canvas-fixed">
      <div id="barSkel" class="chart-skeleton skeleton"></div>
      <canvas id="barChart" class="hidden"></canvas>
    </div>
    <div class="empty" id="barEmpty" style="display:none">No monthly breakdown available.</div>
  </div>

  <div class="how-grid">
    <div class="how-box">
      <h3><img src="assets/left_arrow.png" alt="">Data Sources</h3>
      <ul style="color:#6b7280;margin-left:18px">
        <li>Live Amadeus price quotes</li>
        <li>Aggregated historical daily minimums per route</li>
        <li>Seasonality and holiday effects</li>
        <li>Rolling averages for stability</li>
      </ul>
      <div class="how-footer">Charts reflect historical trends and available pricing signals.</div>
    </div>
    <div class="how-box">
      <h3><img src="assets/brain_symbol.png" alt="">Prediction Model</h3>
      <ul style="color:#6b7280;margin-left:18px">
        <li>Window sampling around target dates</li>
        <li>Cheapest one-way per day; sum for round-trip</li>
        <li>Best/worst/average from sampled window</li>
        <li>Monthly forecast from historical route data</li>
      </ul>
    </div>
  </div>
</div>

<script src="assets/config.js"></script>
<script>
(function(){
  const LatestFetch=(function(){const ctrls=new Map();function keyOf(input){return typeof input==="string"?input:input.url}async function latestFetch(input,init={},group){const k=group||keyOf(input);if(ctrls.has(k)){try{ctrls.get(k).abort()}catch{}}const controller=new AbortController();ctrls.set(k,controller);const opts={...init,signal:controller.signal};const res=await fetch(input,opts);if(ctrls.get(k)!==controller)throw new Error("stale");ctrls.delete(k);return res}return{latestFetch}})();
  function peso(v){return "₱"+Number(v||0).toLocaleString("en-PH")}
  function monlbl(s){var a=(s||"").split("-");if(a.length<2)return "—";return new Date(+a[0],+a[1]-1,1).toLocaleString("en-US",{month:"short"})+" "+a[0]}
  function mean(arr){if(!arr.length)return 0;return arr.reduce((a,b)=>a+b,0)/arr.length}
  var p=new URLSearchParams(location.search);
  var origin=(p.get("origin")||"MNL").toUpperCase();
  var destination=(p.get("destination")||"CEB").toUpperCase();
  var depart=p.get("depart")||"";
  var ret=p.get("return")||"";
  document.getElementById("currentRoute").textContent=origin+" → "+destination;
  document.getElementById("currentDates").textContent=(depart?new Date(depart).toLocaleDateString("en-PH",{month:"short",day:"numeric",year:"numeric"}):"")+(ret?("  •  "+new Date(ret).toLocaleDateString("en-PH",{month:"short",day:"numeric",year:"numeric"})):"");
  var bestMonth=document.getElementById("bestMonth");
  var bestPrice=document.getElementById("bestPrice");
  var expMonth=document.getElementById("expMonth");
  var expPrice=document.getElementById("expPrice");
  var avgFare=document.getElementById("avgFare");
  var savingsEl=document.getElementById("savings");
  var peakEl=document.getElementById("peakPill");
  var bestLabel=document.getElementById("bestLabel");
  var expLabel=document.getElementById("expLabel");
  var avgNote=document.getElementById("avgNote");
  var kpiFilled=false;
  function setSkeleton(on){
    var targets=[bestMonth,bestPrice,expMonth,expPrice,avgFare];
    targets.forEach(function(el){
      if(on){
        el.textContent="";
        el.classList.add("skeleton","inline");
        el.style.width=el===avgFare?"120px":"100px";
      }else{
        el.classList.remove("skeleton","inline");
        el.style.width="";
      }
    });
    document.getElementById("lineSkel").classList.toggle("hidden",!on);
    document.getElementById("barSkel").classList.toggle("hidden",!on);
  }
  function setKPI(best_when, best_price, worst_when, worst_price, avg_value){
    if(best_when){ bestMonth.textContent = monlbl(best_when); }
    if(best_price!=null){ bestPrice.textContent = peso(best_price); }
    if(worst_when){ expMonth.textContent = monlbl(worst_when); }
    if(worst_price!=null){ expPrice.textContent = peso(worst_price); }
    if(avg_value!=null){ avgFare.textContent = peso(avg_value); }
    if(avg_value!=null && best_price!=null){
      var s=Math.max(0,Math.round(((avg_value-best_price)/avg_value)*100)); savingsEl.textContent=s+"% below avg";
    }
    if(avg_value!=null && worst_price!=null){
      var pUp=Math.max(0,Math.round(((worst_price-avg_value)/avg_value)*100)); peakEl.textContent="Up to "+pUp+"% above avg";
    }
    kpiFilled=true;
    setSkeleton(false);
  }
  function drawMoneyLine(ctx, labels, values, opt){
    return new Chart(ctx,{
      type:"line",
      data:{labels,datasets:[{data:values,borderWidth:2.5,tension:.25,borderColor:opt.border,backgroundColor:opt.fill,pointBackgroundColor:opt.border}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{ticks:{callback:v=>"₱"+Number(v).toLocaleString()}}}}
    });
  }
  function drawMoneyBar(ctx, labels, values){
    return new Chart(ctx,{
      type:"bar",
      data:{labels,datasets:[{data:values,backgroundColor:"rgba(37,99,235,0.9)",borderRadius:8,maxBarThickness:48}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{ticks:{callback:v=>"₱"+Number(v).toLocaleString()}}}}
    });
  }
  async function renderMonthlyForecast(){
    try{
      const tok=String(Date.now())+'-'+Math.random().toString(36).slice(2);
      const url=`${SMARTLIPAD.API_BASE}/flights/predictions?origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&months=12&token=${encodeURIComponent(tok)}`;
      const r=await LatestFetch.latestFetch(url, {}, `predictions:${origin}-${destination}`);
      let months=[], fares=[], best=null, worst=null, overall=null;
      if(r.ok){
        const data=await r.json();
        const mf=(data.monthly_forecast||[]);
        months=mf.map(m=>m.month).filter(Boolean);
        fares=mf.map(m=>Number(m.avg_fare||0));
        best=data.best_time||null;
        worst=data.most_expensive||null;
        overall=data.avg_fare||null;
      }
      if(!kpiFilled && best && worst && overall!=null){
        bestLabel.textContent = "Best Time to Fly";
        expLabel.textContent  = "Most Expensive";
        avgNote.textContent   = "12-Month Average";
        setKPI(best.month, best.price, worst.month, worst.price, overall);
      }
      if(!months.length){
        document.getElementById("yearEmpty").style.display="flex";
        document.getElementById("barEmpty").style.display="flex";
        return;
      }
      const shortLabels=months.map(mon=>new Date(mon+"-01").toLocaleString("en-US",{month:"short"}));
      document.getElementById("lineSkel").classList.add("hidden");
      document.getElementById("barSkel").classList.add("hidden");
      document.getElementById("lineChart").classList.remove("hidden");
      document.getElementById("barChart").classList.remove("hidden");
      drawMoneyLine(document.getElementById("lineChart").getContext("2d"),shortLabels,fares,{border:"#2563eb",fill:"rgba(37,99,235,0.08)"});
      drawMoneyBar(document.getElementById("barChart").getContext("2d"),shortLabels,fares);
    }catch{
      document.getElementById("yearEmpty").style.display="flex";
      document.getElementById("barEmpty").style.display="flex";
    }
  }
  (async function init(){
    setSkeleton(true);
    await renderMonthlyForecast();
  })();
})();
</script>
</body>
</html>
