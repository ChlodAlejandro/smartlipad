<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartLipad ‚Äì Route Fare Comparison</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#f6f7fb;--card:#ffffff;--text:#0f172a;--muted:#6b7280;--ring:#e5e7eb;--primary:#2563eb;--success:#16a34a;--danger:#dc2626;--chip:#eff6ff}
    *{box-sizing:border-box} html,body{margin:0;padding:0}
    body{font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg);line-height:1.55}
    .wrap{max-width:1100px;margin:0 auto;padding:24px 20px 60px}
    .topbar{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .back{display:inline-flex;align-items:center;gap:6px;text-decoration:none;color:var(--muted);font-weight:600}
    .back::before{content:"‚Üê";display:inline-block;transform:translateY(-1px)}
    .brand{display:inline-flex;align-items:center;gap:8px;margin:0 auto 0 12px}
    .brand img{width:20px;height:20px;object-fit:contain}
    .brand b{font-size:14px;letter-spacing:.2px}
    .pill-ghost{margin-left:auto;font-size:12px;background:#e8f0ff;color:#1d4ed8;border-radius:999px;padding:6px 10px;border:1px solid #dbe7ff;text-decoration:none}
    h1.title{text-align:center;margin:10px 0 8px;font-size:28px}
    .subtitle{text-align:center;color:var(--muted);margin-bottom:18px}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:16px}
    .section{margin-top:16px}
    .settings-grid{display:grid;gap:12px}
    .inline{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .inline label{font-size:14px;color:var(--muted)}
    .date-pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);border-radius:10px;padding:8px 10px;background:#fff}
    .date-pill input{border:0;outline:0;font:inherit}
    .chips{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;margin-top:6px}
    .chip{padding:10px 12px;border-radius:10px;border:1px solid var(--ring);background:var(--chip);font-weight:600;font-size:14px;color:#1e3a8a;text-align:center;cursor:pointer;user-select:none}
    .chip.red{background:#fee2e2;color:#991b1b} .chip.green{background:#dcfce7;color:#14532d} .chip.outline{background:#fff;color:#334155}
    .banner{margin-top:10px;border-radius:10px;border:1px solid #d1fae5;background:#ecfdf5;padding:10px 12px;color:#065f46;font-weight:600;display:flex;align-items:center;gap:10px}
    .banner::before{content:"‚ñæ";display:inline-block;transform:rotate(-90deg);font-weight:900}
    .legend{display:flex;gap:18px;justify-content:center;font-size:13px;color:var(--muted);margin:8px 0 0;flex-wrap:wrap}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
    .list{display:grid;gap:10px;margin-top:10px}
    .row{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;padding:12px;border-radius:10px;border:1px solid var(--ring);background:#fff}
    .route{font-weight:700} .price{font-weight:800;font-size:18px;color:#1f2937}
    .delta{font-weight:700;font-size:13px} .delta.down{color:var(--success)} .delta.up{color:var(--danger)}
    .btn{border:0;border-radius:10px;padding:10px 12px;font-weight:700;color:#fff;background:var(--primary);text-decoration:none}
    .tips{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .tip{border:1px solid var(--ring);border-radius:12px;background:#fff;padding:14px}
    .tip h4{margin:0 0 6px} .tip p{margin:0;color:var(--muted);font-size:14px} .tip .icon{font-size:20px;margin-right:6px}
    .actions{display:flex;gap:10px;justify-content:center;margin-top:16px} .btn.secondary{background:#111827;color:#fff}
    .badge{position:fixed;right:16px;top:50%;transform:translateY(-50%);background:#0f172a;color:#fff;font-size:12px;padding:8px 10px;border-radius:999px}
    @media (max-width:900px){.chips{grid-template-columns:repeat(2,minmax(0,1fr))}.tips{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:600px){.chips{grid-template-columns:1fr}.row{grid-template-columns:1fr;gap:8px}.actions{flex-direction:column}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back" href="Homepage.html">Back</a>
      <div class="brand"><img src="assets/airplane.png" alt="SmartLipad"><b>SmartLipad</b></div>
      <a class="pill-ghost" href="#" title="Current page">Route Comparison</a>
    </div>

    <h1 class="title">Route Fare Comparison</h1>
    <div class="subtitle">Compare prices across different routes and find the best deals</div>

    <section class="card">
      <div class="settings-grid">
        <div class="inline">
          <label>Reference Date</label>
          <div class="date-pill"><input type="date" id="refDate"></div>
        </div>
        <div>
          <label style="color:#6b7280;font-size:14px">Select Routes to Compare (Choose up to 5)</label>
          <div class="chips" id="routeChips">
            <div class="chip" data-origin="MNL" data-destination="CEB" data-color="blue">Manila ‚Üí Cebu</div>
            <div class="chip red" data-origin="MNL" data-destination="DVO" data-color="red">Manila ‚Üí Davao</div>
            <div class="chip outline" data-origin="MNL" data-destination="ILO">Manila ‚Üí Iloilo</div>
            <div class="chip outline" data-origin="MNL" data-destination="BCD">Manila ‚Üí Bacolod</div>
            <div class="chip outline" data-origin="CEB" data-destination="MNL">Cebu ‚Üí Manila</div>
            <div class="chip green" data-origin="CEB" data-destination="DVO" data-color="green">Cebu ‚Üí Davao</div>
            <div class="chip outline" data-origin="DVO" data-destination="MNL">Davao ‚Üí Manila</div>
            <div class="chip outline" data-origin="DVO" data-destination="CEB">Davao ‚Üí Cebu</div>
            <div class="chip outline" data-origin="ILO" data-destination="MNL">Iloilo ‚Üí Manila</div>
          </div>
          <div id="selCount" style="color:#6b7280;font-size:12px;margin-top:6px">3 routes selected</div>
        </div>
        <div class="banner" id="bestDeal">‚úì Best Deal Found! ‚Äî <span id="bestDealText" style="font-weight:700;margin-left:6px">Loading‚Ä¶</span></div>
      </div>
    </section>

    <section class="card section">
      <h3 style="margin:0 0 6px">12-Month Price Comparison</h3>
      <div style="color:#6b7280;font-size:13px;margin-bottom:8px">Compare fare trends across selected routes</div>
      <canvas id="trendChart" height="110"></canvas>
      <div id="legend" class="legend"></div>
    </section>

    <section class="card section">
      <div style="display:flex;justify-content:space-between;align-items:end;margin-bottom:6px">
        <div>
          <h3 style="margin:0">Current Price Comparison</h3>
          <div style="color:#6b7280;font-size:13px">All routes for <span id="dateLabel"></span></div>
        </div>
      </div>
      <div id="priceList" class="list"></div>
    </section>

    <section class="card section">
      <h3 style="margin:0 0 10px">Money-Saving Tips</h3>
      <div class="tips">
        <div class="tip"><h4><span class="icon">üí°</span>Book in Advance</h4><p>Book 2‚Äì3 months ahead for domestic flights to get better prices</p></div>
        <div class="tip"><h4><span class="icon">üß≠</span>Compare Routes</h4><p>Sometimes connecting flights can be cheaper than direct ones</p></div>
        <div class="tip"><h4><span class="icon">üìÖ</span>Flexible Dates</h4><p>Flying on weekdays is usually cheaper than weekends</p></div>
        <div class="tip"><h4><span class="icon">‚è∞</span>Off-Peak Hours</h4><p>Early morning or late night flights often have lower prices</p></div>
      </div>
      <div class="actions"><a class="btn" href="Homepage.html">Search Flights</a><a class="btn secondary" href="predictions.html">View AI Predictions</a></div>
    </section>

    <div class="badge">Made by ‚Ä¢ you</div>
  </div>

  <script src="assets/config.js"></script>
  <script>
    const refInput = document.getElementById('refDate');
    const dateLabel = document.getElementById('dateLabel');
    const chips = Array.from(document.querySelectorAll('#routeChips .chip'));
    const selCount = document.getElementById('selCount');
    const bestDealBox = document.getElementById('bestDeal');
    const bestDealText = document.getElementById('bestDealText');
    const priceList = document.getElementById('priceList');
    const legendBox = document.getElementById('legend');
    let chart;

    const palette = [
      '#2563eb','#ef4444','#22c55e','#a855f7','#f59e0b',
      '#0ea5e9','#10b981','#e11d48','#7c3aed','#84cc16'
    ];

    function initDate() {
      const t = new Date();
      const pad = n => String(n).padStart(2,'0');
      refInput.value = `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}`;
      dateLabel.textContent = t.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
    }

    function getSelectedRoutes() {
      return chips.filter(c => !c.classList.contains('outline')).slice(0,5).map(c => ({
        origin: c.dataset.origin,
        destination: c.dataset.destination,
        label: c.textContent.trim()
      }));
    }

    function updateSelCount() {
      selCount.textContent = `${getSelectedRoutes().length} routes selected`;
    }

    function toggleChip(e) {
      const el = e.currentTarget;
      const selected = getSelectedRoutes().map(r => r.label);
      if (el.classList.contains('outline')) {
        if (selected.length >= 5) return;
        el.classList.remove('outline');
      } else {
        el.classList.add('outline');
      }
      updateSelCount();
      fetchAndRender();
    }

    chips.forEach(chip => chip.addEventListener('click', toggleChip));

    refInput.addEventListener('change', () => {
      const d = new Date(refInput.value);
      if (!isNaN(d)) {
        dateLabel.textContent = d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
      }
      fetchAndRender();
    });

   function buildQuery() {
    const routes = getSelectedRoutes().map(r => `${r.origin}-${r.destination}`).join(',');
    const ref = refInput.value;
    return `${SMARTLIPAD.API_BASE}/flights/compare/monthly?routes=${encodeURIComponent(routes)}&ref_date=${encodeURIComponent(ref)}`;
    }

    async function fetchAndRender() {
      const url = buildQuery();
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        renderAll(data);
      } catch (err) {
        bestDealText.textContent = 'Unable to load comparison right now';
        priceList.innerHTML = '';
        renderChart({routes:[]});
        console.error(err);
      }
    }

    function renderAll(data) {
      renderBestDeal(data);
      renderList(data);
      renderChart(data);
    }

    function renderBestDeal(data) {
      const best = data?.best_deal;
      if (best && best.route && best.cheaper_by != null) {
        bestDealText.textContent = `${labelFromRoute(best.route)} is ‚Ç±${Number(best.cheaper_by).toLocaleString()} cheaper than usual`;
      } else {
        bestDealText.textContent = 'Select routes to see today‚Äôs best deal';
      }
    }

    function renderList(data) {
      const rows = (data?.routes || []).map(r => {
        const routeLabel = labelFromRoute(r.route);
        const price = r.current_price != null ? `‚Ç±${Number(r.current_price).toLocaleString()}` : '‚Äî';
        const delta = Number(r.delta_vs_avg || 0);
        const deltaText = delta === 0 ? '' : (delta < 0 ? `<span class="delta down">‚ñº ‚Ç±${Math.abs(delta).toLocaleString()}</span>` : `<span class="delta up">‚ñ≤ ‚Ç±${Math.abs(delta).toLocaleString()}</span>`);
        const [o, d] = r.route.split('-');
        const ref = refInput.value;
        const link = `results.html?origin=${o}&destination=${d}&depart=${encodeURIComponent(ref)}`;
        return `
          <div class="row">
            <div class="route">${routeLabel}</div>
            <div class="price">${price} ${deltaText}</div>
            <a class="btn" href="${link}">Book Now</a>
          </div>
        `;
      }).join('');
      priceList.innerHTML = rows || '<div style="color:#6b7280">No routes selected.</div>';
    }

    function renderChart(data) {
      const ctx = document.getElementById('trendChart').getContext('2d');
      if (chart) { chart.destroy(); }
      const routeBlocks = (data?.routes || []);
      const monthLabels = unifyMonths(routeBlocks);
      const datasets = routeBlocks.map((r, idx) => {
        const color = palette[idx % palette.length];
        const map = new Map((r.series || []).map(p => [p.month, Number(p.price)]));
        const series = monthLabels.map(m => map.get(m) ?? null);
        return {
          label: labelFromRoute(r.route),
          data: series,
          borderColor: color,
          backgroundColor: hexToRGBA(color, 0.12),
          pointBackgroundColor: color,
          tension: .3,
          borderWidth: 2
        };
      });

      chart = new Chart(ctx, {
        type: 'line',
        data: { labels: monthLabels.map(m => monthToShort(m)), datasets },
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
      });

      legendBox.innerHTML = routeBlocks.map((r, idx) => {
        const color = palette[idx % palette.length];
        return `<span><span class="dot" style="background:${color}"></span>${labelFromRoute(r.route)}</span>`;
      }).join('');
    }

    function unifyMonths(routeBlocks) {
      const set = new Set();
      routeBlocks.forEach(r => (r.series||[]).forEach(p => set.add(p.month)));
      return Array.from(set).sort();
    }

    function monthToShort(ym) {
      const [y, m] = ym.split('-').map(Number);
      const d = new Date(y, m-1, 1);
      return d.toLocaleDateString(undefined, { month: 'short', year:'2-digit' });
    }

    function labelFromRoute(route) {
      const [o,d] = route.split('-');
      const map = {
        MNL:'Manila', CEB:'Cebu', DVO:'Davao', ILO:'Iloilo', BCD:'Bacolod',
        CRK:'Clark', KLO:'Kalibo', MPH:'Caticlan', TAG:'Bohol'
      };
      return `${map[o]||o} ‚Üí ${map[d]||d}`;
    }

    function hexToRGBA(hex, a=0.2){
      const c = hex.replace('#','');
      const n = parseInt(c,16);
      const r = (n>>16)&255, g=(n>>8)&255, b=n&255;
      return `rgba(${r},${g},${b},${a})`;
    }

    function initFromURL() {
      const p = new URLSearchParams(location.search);
      const routes = (p.get('routes')||'').split(',').filter(Boolean);
      const ref = p.get('ref_date');
      if (ref) refInput.value = ref;
      if (routes.length) {
        chips.forEach(c => {
          const key = `${c.dataset.origin}-${c.dataset.destination}`;
          if (routes.includes(key)) c.classList.remove('outline'); else c.classList.add('outline');
        });
      } else {
        chips.forEach((c,i)=>{ if(i<3) c.classList.remove('outline'); else c.classList.add('outline'); });
      }
      updateSelCount();
    }

    initDate();
    initFromURL();
    fetchAndRender();
  </script>
</body>
</html>
