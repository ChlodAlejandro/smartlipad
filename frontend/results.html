<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartLipad ‚Äì Results</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f7fafc;--card:#ffffff;--text:#0f172a;--muted:#6b7280;--ring:#e5e7eb;--primary:#2563eb;--shadow:0 8px 28px rgba(15,23,42,.08);--success:#16a34a;}
    *{box-sizing:border-box} html,body{margin:0;padding:0}
    body{font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:#f6f8fb;line-height:1.55}
    .wrap{max-width:1100px;margin:0 auto;padding:18px 20px 80px}
    .topbar{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    a.back{text-decoration:none;color:var(--muted);font-weight:600;display:inline-flex;gap:6px;align-items:center}
    a.back::before{content:"‚Üê";display:inline-block;transform:translateY(-1px)}
    .brand{display:flex;align-items:center;gap:8px;margin:0 auto 0 12px}
    .brand img{width:18px;height:18px;object-fit:contain}
    .brand b{font-size:13px;letter-spacing:.2px}
    .tag{margin-left:auto;background:#eaf2ff;color:#1e40af;border:1px solid #d8e6ff;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;text-decoration:none}
    .bar{background:var(--card);border:1px solid var(--ring);border-radius:12px;padding:12px;box-shadow:var(--shadow);display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{border:1px solid var(--ring);border-radius:10px;background:#fff;padding:8px 10px;font-weight:700;font-size:14px}
    .sep{color:#cbd5e1}
    .right{margin-left:auto;display:flex;gap:8px;align-items:center}
    select{border:1px solid var(--ring);border-radius:8px;padding:8px 10px;background:#fff;font:inherit}
    .results{display:grid;gap:10px;margin-top:12px}
    .card{background:#fff;border:1px solid var(--ring);border-radius:12px;padding:12px;display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
    .air{display:flex;align-items:center;gap:10px}
    .logo{width:24px;height:24px;border-radius:50%;display:grid;place-items:center;font-size:12px;font-weight:800;color:#fff;background:#ef4444}
    .air .name{font-weight:700}
    .meta{display:grid;grid-template-columns:80px 1fr 80px;gap:16px;margin-top:6px;color:#1f2937}
    .time{font-weight:800}
    .dur{color:var(--muted);font-size:13px}
    .stops{font-size:12px;color:#0f172a;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;padding:4px 8px;justify-self:start}
    .pricebox{text-align:right}
    .price{font-weight:800;font-size:18px}
    .btn{display:inline-block;margin-top:8px;background:var(--primary);color:#fff;border:0;border-radius:10px;padding:10px 12px;font-weight:800;text-decoration:none}
    .tips{margin-top:12px;background:#fff;border:1px solid var(--ring);border-radius:12px;padding:12px}
    .tips h4{margin:0 0 6px} .tips p{margin:0;color:#6b7280;font-size:14px}
    .badge{position:fixed;right:18px;bottom:18px;background:#0f172a;color:#fff;padding:6px 10px;border-radius:10px;font-size:12px;box-shadow:var(--shadow)}
    @media (max-width:640px){.meta{grid-template-columns:1fr;gap:4px}.pricebox{text-align:left}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back" href="search.html">Back</a>
      <div class="brand"><img src="assets/airplane.png" alt="SmartLipad logo"><b>SmartLipad</b></div>
      <a class="tag" id="countTag" href="#">0 flights found</a>
    </div>
    <div class="bar">
      <div class="chip" id="routeChip">‚Äî</div><span class="sep">‚Ä¢</span>
      <div class="chip" id="dateChip">‚Äî</div><span class="sep">‚Ä¢</span>
      <div class="chip" id="paxChip">‚Äî</div>
      <div class="right">
        <label style="font-size:12px;color:#6b7280">Sort</label>
        <select id="sortSel"><option value="price">Lowest price</option><option value="duration">Shortest duration</option><option value="depart">Earliest departure</option></select>
        <label style="font-size:12px;color:#6b7280">Stops</label>
        <select id="stopsSel"><option value="any">Any</option><option value="0">Non-stop</option><option value="1">1 stop</option></select>
      </div>
    </div>
    <div class="results" id="results"></div>
    <div class="tips"><h4>üí° Pro Tips</h4><p>Prices are generally lower when you book 1‚Äì2 months in advance. Try to avoid peak hours (5‚Äì9am & 5‚Äì9pm).</p></div>
    <div class="badge">Made by ‚Ä¢ you</div>
  </div>

  <script src="assets/config.js"></script>
  <script>
    function fmtCurrency(v,c){const n=Number(v);return Number.isFinite(n)?n.toLocaleString("en-PH",{style:"currency",currency:c||"PHP"}):"‚Äî"}
    function toHHMM(t){if(!t)return"";if(/^\d{2}:\d{2}$/.test(t))return t;const d=new Date(t);if(isNaN(d))return"";return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0")}
    function minutesFromISO(dur){if(!dur)return null;let m=dur.match(/^PT(?:(\d+)H)?(?:(\d+)M)?$/i);if(!m)m=dur.match(/^(?:(\d+)h)?(?:(\d+)m)?$/i);if(!m)return null;return (m[1]?+m[1]*60:0)+(m[2]?+m[2]:0)}
    function yyyymmdd(iso){const [y,m,d]=String(iso||"").split("-");return y&&m&&d?`${y}${m}${d}`:""}
    function fallbackLink(origin,destination,date,currency,adults){return `https://www.skyscanner.com/transport/flights/${origin.toLowerCase()}/${destination.toLowerCase()}/${yyyymmdd(date)}/?adults=${adults}&cabinclass=economy&currency=${currency}`}
    function render(offers,origin,destination,currency,date,adults){
      const wrap=document.getElementById("results");
      wrap.innerHTML="";
      document.getElementById("countTag").textContent=`${offers.length} flights found`;
      if(!offers.length){wrap.innerHTML=`<div class="tips"><h4>No offers</h4><p>Try another date or route.</p></div>`;return}
      const fb=fallbackLink(origin,destination,date,currency,adults);
      for(const o of offers){
        const logoText=(o.airline_code||"XX").slice(0,2).toUpperCase();
        const airline=o.airline_name||o.carrier||"Airline";
        const dep=toHHMM(o.departure_time);
        const arr=toHHMM(o.arrival_time);
        const dur=o.duration_human||o.duration||"";
        const aircraft=o.aircraft||"";
        const stopsNum=typeof o.stops==="number"?o.stops:0;
        const stopsText=(stopsNum===0)?"Non-stop":`${stopsNum} stop${stopsNum>1?"s":""}`;
        const priceVal=o.price_total??o.price?.total??o.total??o.amount??o.minPrice??o.fare??o.price;
        const price=fmtCurrency(priceVal,currency);
        const link=o.deeplink||o.deep_link||fb;
        const color="#2563eb";
        const card=document.createElement("div");
        card.className="card";
        card.innerHTML=
          `<div>
            <div class="air">
              <div class="logo" style="background:${color}">${logoText}</div>
              <div class="name">${airline}</div>
            </div>
            <div class="meta">
              <div class="time">${dep||"‚Äî"}</div>
              <div class="dur">${dur}${aircraft?` ¬∑ ${aircraft}`:""}</div>
              <div class="time" style="text-align:right">${arr||"‚Äî"}</div>
            </div>
            <span class="stops">${stopsText} ‚Ä¢ ${origin} ‚Üí ${destination}</span>
          </div>
          <div class="pricebox">
            <div class="price">${price}</div>
            <a class="btn" href="${link}" target="_blank" rel="noopener">Book Now</a>
          </div>`;
        wrap.appendChild(card);
      }
    }
    (async()=>{
      const p=new URLSearchParams(location.search);
      const origin=(p.get("origin")||"").toUpperCase();
      const destination=(p.get("destination")||"").toUpperCase();
      const date=p.get("date")||"";
      const adults=+(p.get("adults")||1);
      const currency=p.get("currency")||"PHP";
      document.getElementById("routeChip").textContent=`${origin} ‚Üí ${destination}`;
      document.getElementById("dateChip").textContent=date||"‚Äî";
      document.getElementById("paxChip").textContent=`${adults} adult${adults>1?"s":""}, Economy`;
      const api=window.SMARTLIPAD.API_BASE;
      const url=`${api}/flights/flight-offers?origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&date=${encodeURIComponent(date)}&adults=${encodeURIComponent(adults)}&currency=${encodeURIComponent(currency)}`;
      let data;
      try{
        const r=await fetch(url);
        if(!r.ok)throw new Error(`${r.status} ${await r.text()}`);
        data=await r.json();
      }catch{
        location.href="error.html";
        return;
      }
      const raw=Array.isArray(data)?data:(Array.isArray(data.offers)?data.offers:(Array.isArray(data.data)?data.data:[]));
      const norm=raw.map(o=>({
        airline_code:o.airline_code||o.validating_airline||o.carrierCode||"XX",
        airline_name:o.airline_name||o.carrier||o.carrierName||o.validatingAirline||"Airline",
        departure_time:o.departure_time||o.departure||(o.itineraries?.[0]?.segments?.[0]?.departure?.at)||"",
        arrival_time:o.arrival_time||o.arrival||(o.itineraries?.[0]?.segments?.slice(-1)[0]?.arrival?.at)||"",
        duration:o.duration||(o.itineraries?.[0]?.duration)||"",
        duration_human:o.duration_human||"",
        aircraft:o.aircraft||"",
        stops:typeof o.stops==="number"?o.stops:((o.itineraries?.[0]?.segments?.length||1)-1),
        price:o.price_total??o.price?.total??o.total??o.amount??o.minPrice??o.fare??o.price,
        deeplink:o.deeplink||o.deep_link||""
      }));
      const sortSel=document.getElementById("sortSel");
      const stopsSel=document.getElementById("stopsSel");
      function apply(){
        let arr=[...norm];
        const stopsVal=stopsSel.value;
        if(stopsVal!=="any"){
          const n=+stopsVal;
          arr=arr.filter(x=>x.stops===n);
        }
        const key=sortSel.value;
        if(key==="price"){
          arr.sort((a,b)=>{
            const ap=Number(a.price);const bp=Number(b.price);
            if(!Number.isFinite(ap)&&!Number.isFinite(bp))return 0;
            if(!Number.isFinite(ap))return 1;
            if(!Number.isFinite(bp))return -1;
            return ap-bp;
          });
        }else if(key==="duration"){
          arr.sort((a,b)=>(minutesFromISO(a.duration)??1e9)-(minutesFromISO(b.duration)??1e9));
        }else if(key==="depart"){
          const toMin=t=>{if(!t)return 1e9;if(/^\d{2}:\d{2}$/.test(t)){const[h,m]=t.split(":").map(Number);return h*60+m}const d=new Date(t);return isNaN(d)?1e9:d.getHours()*60+d.getMinutes()};
          arr.sort((a,b)=>toMin(a.departure_time)-toMin(b.departure_time));
        }
        render(arr,origin,destination,currency,date,adults);
      }
      sortSel.addEventListener("change",apply);
      stopsSel.addEventListener("change",apply);
      apply();
    })();
  </script>
</body>
</html>
